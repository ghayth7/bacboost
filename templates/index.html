<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>BacBoost</title>

    <!-- MathJax Config -->
    <script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$']],
            displayMath: [['$$', '$$']]
        },
        svg: { fontCache: 'global' }
    };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<style>
body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    padding: 40px;

    background:
        linear-gradient(135deg, #e0f7fa, #f1f8ff),
        linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);

    background-size:
        100% 100%,
        40px 40px,
        40px 40px;
}

h1 {
    text-align: center;
    margin-bottom: 30px;
}

select, button, textarea {
    font-size: 14px;
}

button {
    background: #1976d2;
    color: white;
    transition: 0.3s ease;
}

button:hover {
    transform: scale(1.05);
}

.main-layout {
    display: flex;
    gap: 20px;
}

.exercise-area {
    flex: 3;
}

.question-box {
    background: white;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 10px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
}

#chat-container {
    flex: 1;
    position: sticky;
    top: 20px;
    max-height: 600px;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    padding: 15px;
}

#chat-history {
    flex: 1;
    margin: 10px 0;
    overflow-y: hidden;
    overflow-x: hidden;
    padding-right: 5px;
}

#chat-history:hover {
    overflow-y: auto;
}

#chat-history::-webkit-scrollbar {
    width: 6px;
}

#chat-history::-webkit-scrollbar-thumb {
    background: #bbb;
    border-radius: 10px;
}

#user-message {
    width: 100%;
    height: 60px;
    resize: none;
    margin-bottom: 10px;
}

button {
    padding: 8px;
    cursor: pointer;
    border: none;
    border-radius: 6px;
}

#send-message, #reset-chat {
    background-color: #4CAF50;
    color: white;
}

#send-message:hover, #reset-chat:hover {
    background-color: #45a049;
}
.solution-content {
    overflow: hidden;
    transition: max-height 0.4s ease, opacity 0.3s ease;
    max-height: 0;
    opacity: 0;
}

.solution-content.show {
    max-height: 1000px; /* large enough */
    opacity: 1;
    margin-top: 10px;
}
.lesson-content {
    line-height: 1.7;
}

.lesson-content h1 {
    margin-top: 20px;
    font-size: 26px;
}

.lesson-content h2 {
    margin-top: 25px;
    color: #1976d2;
}

.lesson-content h3 {
    margin-top: 15px;
}

.lesson-content ul {
    padding-left: 20px;
    margin-bottom: 15px;
}

.lesson-content p {
    margin-bottom: 12px;
}
#lesson-container {
    margin-top: 20px;
}

.control-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
    align-items: end;
    background: white;
    padding: 25px;
    border-radius: 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    margin: 30px 0;
}

.select-group {
    display: flex;
    flex-direction: column;
}

.select-group label {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
    color: #555;
}

.select-group select {
    padding: 12px 15px;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    background: #f9fbff;
    transition: all 0.3s ease;
    cursor: pointer;
}

.select-group select:hover {
    border-color: #4a90e2;
}

.select-group select:focus {
    outline: none;
    border-color: #4a90e2;
    box-shadow: 0 0 0 3px rgba(74,144,226,0.2);
}

.button-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.button-group button {
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    background: linear-gradient(135deg, #4a90e2, #357abd);
    color: white;
    transition: all 0.3s ease;
}

.button-group button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}
.chat-card {
    background: rgba(255,255,255,0.95);
    border-radius: 22px;
    padding: 20px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    gap: 15px;
    height: 100%;
    width: 350px;
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-title {
    font-weight: 700;
    font-size: 18px;
}

.chat-status {
    font-size: 11px;
    background: #4CAF50;
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    margin-left: 8px;
}

.reset-btn {
    background: #ff5c5c;
    border: none;
    padding: 6px 14px;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    transition: 0.3s;
}

.reset-btn:hover {
    transform: scale(1.05);
}

.chat-messages {
    flex: 1;                 /* this makes it fill available space */
    overflow-y: auto;
    padding: 15px;
    background: #f4f7fb;
    border-radius: 16px;
    font-size: 14px;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
}

/* Input Area */
.chat-input-area {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Textarea */
#user-message {
    flex: 1;
    height: 50px;
    min-height: 50px;
    max-height: 120px;
    border-radius: 14px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    resize: none;
    overflow-y: auto;
    font-size: 14px;
    transition: 0.3s;
}

#user-message:focus {
    outline: none;
    border-color: #4a90e2;
    box-shadow: 0 0 0 3px rgba(74,144,226,0.2);
}

/* Buttons */
.chat-input-area button {
    height: 50px;
    background: linear-gradient(135deg, #4CAF50, #2e7d32);
    border: none;
    border-radius: 14px;
    padding: 0 18px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
}

.chat-input-area button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}
.main-layout {
    display: flex;
    gap: 30px;
    align-items: flex-start;
}

/* Left side = 65% */
.exercise-area {
    flex: 0 0 65%;
}

/* Right side = 35% */
.chat-card {
    flex: 0 0 35%;
    min-width: 320px;
}

body {
    background: linear-gradient(
        to bottom,
        #dbeaf0,
        #cfdfe6
    );
}
body {
    background-color: #d8e6ec;
    position: relative;
}

body::before {
    content: "";
    position: fixed;
    right: -150px;
    bottom: -150px;
    width: 700px;
    height: 700px;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 500 500' xmlns='http://www.w3.org/2000/svg'%3E%3Cg stroke='%23005a78' stroke-width='3' fill='none' opacity='0.05'%3E%3Ccircle cx='250' cy='250' r='180'/%3E%3Cline x1='250' y1='70' x2='250' y2='430'/%3E%3Cline x1='70' y1='250' x2='430' y2='250'/%3E%3Cline x1='140' y1='140' x2='360' y2='360'/%3E%3Cline x1='360' y1='140' x2='140' y2='360'/%3E%3C/g%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-size: contain;
    pointer-events: none;
    z-index: -1;
}
.empty-state {
    background: rgba(255,255,255,0.8);
    border-radius: 20px;
    padding: 60px 40px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.08);
    color: #5f6c7b;
    backdrop-filter: blur(4px);
}

.empty-state h2 {
    margin-top: 15px;
    font-size: 22px;
    color: #2f3e4d;
}

.empty-state p {
    margin-top: 10px;
    font-size: 15px;
    line-height: 1.6;
}

.empty-icon {
    font-size: 42px;
    opacity: 0.6;
}


</style>
</head>

<body>

<h1>üöÄ BacBoost - G√©n√©rateur d'exercices Bac</h1>

<div class="control-panel">

    <div class="select-group">
        <label>Section</label>
        <select id="section">
            <option value="">Choisir une section</option>
            <option value="Mathematics">Math√©matiques</option>
            <option value="Science">Sciences</option>
            <option value="Economics">√âconomie</option>
            <option value="Technical">Technique</option>
            <option value="Informatique">Informatique</option>
        </select>
    </div>

    <div class="select-group">
        <label>Le√ßon</label>
        <select id="lesson">
            <option value="">Choisir une le√ßon</option>
        </select>
    </div>

    <div class="select-group">
        <label>Difficult√©</label>
        <select id="difficultySelect">
            <option value="easy">Facile</option>
            <option value="medium" selected>Moyen</option>
            <option value="hard">Difficile</option>
        </select>
    </div>

    <div class="button-group">
        <button id="generateBtn">G√©n√©rer</button>
        <button id="lessonBtn">demander le cours</button>
        <button id="toggleLessonBtn">Masquer</button>
    </div>

</div>


<hr>

<div class="main-layout">
    <div class="exercise-area">
        <div id="placeholder" class="empty-state">
    <div class="empty-icon">üìò</div>
    <h2>Pr√™t √† commencer ?</h2>
    <p>
        S√©lectionnez une section et une le√ßon,
        puis cliquez sur <strong>G√©n√©rer</strong> ou
        <strong>demander le cours</strong>.
    </p>
</div>


        <!-- LESSON WILL APPEAR HERE -->
        <div id="lesson-container" class="question-box" style="display:none;"></div>

        <!-- EXERCISES -->
        <div id="exam-container"></div>

    </div>

    <div id="chat-container" class="chat-card">

    <div class="chat-header">
        <div class="chat-title">
            ü§ñ AI Tutor
            <span class="chat-status">Online</span>
        </div>
        <button id="reset-chat" class="reset-btn">Reset</button>
    </div>

    <div id="chat-history" class="chat-messages"></div>

<div class="chat-input-area">
    <textarea id="user-message" placeholder="Posez votre question..."></textarea>
    <button id="mic-button">üé§</button>
    <button id="send-message">Envoyer</button>
</div>

       
    </div>

</div>

</div>
<script>
window.MathJax = {
  tex: {
    packages: {'[+]': ['noerrors']},
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  },
  options: {
    renderActions: {
      addMenu: []
    }
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>




<script>

let chatHistory = [];
let currentQuestions = [];

const sectionSelect = document.getElementById("section");
const lessonSelect = document.getElementById("lesson");
const difficultySelect = document.getElementById("difficultySelect");

const sendMessageButton = document.getElementById("send-message");
const userMessageInput = document.getElementById("user-message");
const chatHistoryContainer = document.getElementById("chat-history");
const resetChatButton = document.getElementById("reset-chat");


// =========================
// LOAD LESSONS
// =========================
sectionSelect.addEventListener("change", function () {

    const section = sectionSelect.value;
    lessonSelect.innerHTML = "<option value=''>Choisir une le√ßon</option>";

    if (!section) return;

    fetch(`/lessons/${section}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            data.lessons.forEach(lesson => {
                const option = document.createElement("option");
                option.value = lesson;
                option.textContent = lesson;
                lessonSelect.appendChild(option);
            });
        });
});


// =========================
// GENERATE EXERCISES
// =========================
document.getElementById("generateBtn").addEventListener("click", function () {

    const section = sectionSelect.value;
    const lesson = lessonSelect.value;
    const difficulty = difficultySelect.value;

    if (!section || !lesson) {
        alert("Veuillez s√©lectionner une section et une le√ßon.");
        return;
    }

    fetch("/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ section, lesson, difficulty })
    })
    .then(res => res.json())
    .then(data => {

        if (data.error) {
            alert(data.error);
            return;
        }
        document.getElementById("placeholder").style.display = "none";

        const container = document.getElementById("exam-container");
        container.innerHTML = "";

        currentQuestions = data.questions;

        // Reset chat properly
        chatHistory = [];
        chatHistoryContainer.innerHTML = "";

        data.questions.forEach((question, index) => {

            const div = document.createElement("div");
            div.className = "question-box";

            div.innerHTML = `
                <h3>Exercice ${index + 1}</h3>
                <div>${question}</div>
                <br>
              <button onclick="toggleSolution(${index + 1})" id="btn-${index + 1}">
        Voir la correction
          </button>


                <div id="solution-${index + 1}" class="solution-content"></div>

            `;

            div.dataset.question = question;
            container.appendChild(div);
        });

        if (window.MathJax) MathJax.typesetPromise();
    });
});


// =========================
// SOLVE QUESTION
// =========================
function toggleSolution(questionId) {

    const solutionDiv = document.getElementById("solution-" + questionId);
    const button = document.getElementById("btn-" + questionId);

    // If already visible ‚Üí hide smoothly
    if (solutionDiv.classList.contains("show")) {
        solutionDiv.classList.remove("show");

        setTimeout(() => {
            solutionDiv.innerHTML = "";
        }, 300);

        button.textContent = "Voir la correction";
        return;
    }

  const questionText = currentQuestions[questionId - 1];


    solutionDiv.innerHTML = "<p>‚è≥ G√©n√©ration de la correction...</p>";

    fetch("/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question_text: questionText })
    })
    .then(res => res.json())
    .then(data => {

        if (data.error) {
            solutionDiv.innerHTML = "<p style='color:red;'>Erreur lors de la g√©n√©ration.</p>";
            return;
        }

        let formattedSolution = data.solution;

        // Fix step formatting safely
        formattedSolution = formattedSolution.replace(
            /(√âtape\s+\d+\s*:)/g,
            "<br><br><strong>$1</strong>"
        );

        solutionDiv.innerHTML = `
            <p><strong>Correction :</strong></p>
            <div>${formattedSolution}</div>
        `;

        // Add animation AFTER content is inserted
        setTimeout(() => {
            solutionDiv.classList.add("show");
        }, 10);

        button.textContent = "Masquer la correction";

        if (window.MathJax) MathJax.typesetPromise();
    });
}




// =========================
// CHAT
// =========================
sendMessageButton.addEventListener("click", function () {

    const userMessage = userMessageInput.value.trim();
    if (!userMessage) return;

    displayMessage("Vous", userMessage);
    userMessageInput.value = "";

    fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            section: sectionSelect.value,
            lesson: lessonSelect.value,
            difficulty: difficultySelect.value,
            questions: currentQuestions,
            history: chatHistory,
            message: userMessage
        })
    })
    .then(res => res.json())
    .then(data => {

        if (data.error) {
            alert(data.error);
            return;
        }

        displayMessage("AI Tutor", data.reply);

        chatHistory.push(
            { role: "user", content: userMessage },
            { role: "assistant", content: data.reply }
        );

        if (window.MathJax) MathJax.typesetPromise();
    });
});

function displayMessage(sender, message) {

    const messageDiv = document.createElement("div");

    messageDiv.innerHTML = `
        <p><strong>${sender}:</strong></p>
        <div>${marked.parse(message)}</div>
        <hr>
    `;

    chatHistoryContainer.appendChild(messageDiv);

    if (window.MathJax) {
        MathJax.typesetPromise([messageDiv]);
    }

    chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
}

// =========================
// RESET CHAT
// =========================
resetChatButton.addEventListener("click", function () {
    chatHistory = [];
    chatHistoryContainer.innerHTML = "";
});
document.getElementById("lessonBtn").addEventListener("click", function () {

    const section = sectionSelect.value;
    const lesson = lessonSelect.value;

    if (!section || !lesson) {
        alert("Veuillez s√©lectionner une section et une le√ßon.");
        return;
    }

    const lessonContainer = document.getElementById("lesson-container");

    lessonContainer.style.display = "block";
    lessonContainer.innerHTML = "‚è≥ G√©n√©ration du cours...";


    fetch("/lesson_content", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ section, lesson })
    })
    .then(res => res.json())
    .then(data => {

        if (data.error) {
            lessonContainer.innerHTML = "Erreur lors de la g√©n√©ration.";
            return;
        }
        document.getElementById("placeholder").style.display = "none";

      lessonContainer.innerHTML = `
    <div class="lesson-content">
        ${marked.parse(data.lesson)}
    </div>
`;


        if (window.MathJax) MathJax.typesetPromise();
    });
});
const micButton = document.getElementById("mic-button");
const sendButton = document.getElementById("send-message");

let recognition;
let isListening = false;

// Detect support properly
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = "fr-FR";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = () => {
        isListening = true;
        micButton.classList.add("listening");
        userMessageInput.placeholder = "üé§ J'√©coute...";
    };

    recognition.onend = () => {
        isListening = false;
        micButton.classList.remove("listening");
        userMessageInput.placeholder = "Posez votre question...";
    };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    userMessageInput.value += " " + transcript;
};


    recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
    };

    micButton.addEventListener("click", () => {
        if (!isListening) {
            recognition.start();
        } else {
            recognition.stop();
        }
    });

} else {
    // Hide mic if unsupported
    micButton.style.display = "none";
}


</script>
<script>
    const toggleLessonBtn = document.getElementById("toggleLessonBtn");
    const lessonContainer = document.getElementById("lesson-container");

    toggleLessonBtn.addEventListener("click", function () {
        if (lessonContainer.style.display === "none") {
            lessonContainer.style.display = "block";
            toggleLessonBtn.textContent = "Masquer le cours";
        } else {
            lessonContainer.style.display = "none";
            toggleLessonBtn.textContent = "Afficher le cours";
        }
    });
</script>

</body>
</html>
