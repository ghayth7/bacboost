<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>BacBoost</title>

    <!-- MathJax Config -->
    <script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$']],
            displayMath: [['$$', '$$']]
        },
        svg: { fontCache: 'global' }
    };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<style>
body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    padding: 40px;
    background: linear-gradient(135deg, #e0f7fa, #f1f8ff);
}
h1 {
    text-align: center;
    margin-bottom: 30px;
}

select, button, textarea {
    font-size: 14px;
}

button {
    background: #1976d2;
    color: white;
    transition: 0.3s ease;
}

button:hover {
    transform: scale(1.05);
}

.main-layout {
    display: flex;
    gap: 20px;
}

.exercise-area {
    flex: 3;
}

.question-box {
    background: white;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 10px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
}

#chat-container {
    flex: 1;
    position: sticky;
    top: 20px;
    max-height: 600px;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    padding: 15px;
}

#chat-history {
    flex: 1;
    margin: 10px 0;
    overflow-y: hidden;
    overflow-x: hidden;
    padding-right: 5px;
}

#chat-history:hover {
    overflow-y: auto;
}

#chat-history::-webkit-scrollbar {
    width: 6px;
}

#chat-history::-webkit-scrollbar-thumb {
    background: #bbb;
    border-radius: 10px;
}

#user-message {
    width: 100%;
    height: 60px;
    resize: none;
    margin-bottom: 10px;
}

button {
    padding: 8px;
    cursor: pointer;
    border: none;
    border-radius: 6px;
}

#send-message, #reset-chat {
    background-color: #4CAF50;
    color: white;
}

#send-message:hover, #reset-chat:hover {
    background-color: #45a049;
}
.solution-content {
    overflow: hidden;
    transition: max-height 0.4s ease, opacity 0.3s ease;
    max-height: 0;
    opacity: 0;
}

.solution-content.show {
    max-height: 1000px; /* large enough */
    opacity: 1;
    margin-top: 10px;
}
.lesson-content {
    line-height: 1.7;
}

.lesson-content h1 {
    margin-top: 20px;
    font-size: 26px;
}

.lesson-content h2 {
    margin-top: 25px;
    color: #1976d2;
}

.lesson-content h3 {
    margin-top: 15px;
}

.lesson-content ul {
    padding-left: 20px;
    margin-bottom: 15px;
}

.lesson-content p {
    margin-bottom: 12px;
}
#lesson-container {
    margin-top: 20px;
}


</style>
</head>

<body>

<h1>üöÄ BacBoost - G√©n√©rateur d'exercices Bac</h1>

<select id="section">
    <option value="">Choisir une section</option>
    <option value="Mathematics">Math√©matiques</option>
    <option value="Science">Sciences</option>
    <option value="Economics">√âconomie</option>
    <option value="Technical">Technique</option>
    <option value="Informatique">Informatique</option>
</select>

<select id="lesson">
    <option value="">Choisir une le√ßon</option>
</select>

<select id="difficultySelect">
    <option value="easy">Facile</option>
    <option value="medium" selected>Moyen</option>
    <option value="hard">Difficile</option>
</select>

<button id="generateBtn">G√©n√©rer les exercices</button>
<button id="lessonBtn">Voir le cour</button>


<hr>
<div id="lesson-container" class="question-box"></div>



<div class="main-layout">
    <div class="exercise-area">
        <div id="exam-container"></div>
    </div>

    <div id="chat-container">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>AI Tutor</h3>
            <button id="reset-chat">Reset Chat</button>
        </div>
        <div id="chat-history"></div>
        <textarea id="user-message" placeholder="Posez votre question..."></textarea>
        <button id="send-message">Envoyer</button>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


<script>

let chatHistory = [];
let currentQuestions = [];

const sectionSelect = document.getElementById("section");
const lessonSelect = document.getElementById("lesson");
const difficultySelect = document.getElementById("difficultySelect");

const sendMessageButton = document.getElementById("send-message");
const userMessageInput = document.getElementById("user-message");
const chatHistoryContainer = document.getElementById("chat-history");
const resetChatButton = document.getElementById("reset-chat");


// =========================
// LOAD LESSONS
// =========================
sectionSelect.addEventListener("change", function () {

    const section = sectionSelect.value;
    lessonSelect.innerHTML = "<option value=''>Choisir une le√ßon</option>";

    if (!section) return;

    fetch(`/lessons/${section}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            data.lessons.forEach(lesson => {
                const option = document.createElement("option");
                option.value = lesson;
                option.textContent = lesson;
                lessonSelect.appendChild(option);
            });
        });
});


// =========================
// GENERATE EXERCISES
// =========================
document.getElementById("generateBtn").addEventListener("click", function () {

    const section = sectionSelect.value;
    const lesson = lessonSelect.value;
    const difficulty = difficultySelect.value;

    if (!section || !lesson) {
        alert("Veuillez s√©lectionner une section et une le√ßon.");
        return;
    }

    fetch("/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ section, lesson, difficulty })
    })
    .then(res => res.json())
    .then(data => {

        if (data.error) {
            alert(data.error);
            return;
        }

        const container = document.getElementById("exam-container");
        container.innerHTML = "";

        currentQuestions = data.questions;

        // Reset chat properly
        chatHistory = [];
        chatHistoryContainer.innerHTML = "";

        data.questions.forEach((question, index) => {

            const div = document.createElement("div");
            div.className = "question-box";

            div.innerHTML = `
                <h3>Exercice ${index + 1}</h3>
                <div>${question}</div>
                <br>
              <button onclick="toggleSolution(${index + 1})" id="btn-${index + 1}">
        Voir la correction
          </button>


                <div id="solution-${index + 1}" class="solution-content"></div>

            `;

            div.dataset.question = question;
            container.appendChild(div);
        });

        if (window.MathJax) MathJax.typesetPromise();
    });
});


// =========================
// SOLVE QUESTION
// =========================
function toggleSolution(questionId) {

    const solutionDiv = document.getElementById("solution-" + questionId);
    const button = document.getElementById("btn-" + questionId);

    // If already visible ‚Üí hide smoothly
    if (solutionDiv.classList.contains("show")) {
        solutionDiv.classList.remove("show");

        setTimeout(() => {
            solutionDiv.innerHTML = "";
        }, 300);

        button.textContent = "Voir la correction";
        return;
    }

    const questionDiv = document.querySelectorAll(".question-box")[questionId - 1];
    const questionText = questionDiv.dataset.question;

    solutionDiv.innerHTML = "<p>‚è≥ G√©n√©ration de la correction...</p>";

    fetch("/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question_text: questionText })
    })
    .then(res => res.json())
    .then(data => {

        if (data.error) {
            solutionDiv.innerHTML = "<p style='color:red;'>Erreur lors de la g√©n√©ration.</p>";
            return;
        }

        let formattedSolution = data.solution;

        // Fix step formatting safely
        formattedSolution = formattedSolution.replace(
            /(√âtape\s+\d+\s*:)/g,
            "<br><br><strong>$1</strong>"
        );

        solutionDiv.innerHTML = `
            <p><strong>Correction :</strong></p>
            <div>${formattedSolution}</div>
        `;

        // Add animation AFTER content is inserted
        setTimeout(() => {
            solutionDiv.classList.add("show");
        }, 10);

        button.textContent = "Masquer la correction";

        if (window.MathJax) MathJax.typesetPromise();
    });
}




// =========================
// CHAT
// =========================
sendMessageButton.addEventListener("click", function () {

    const userMessage = userMessageInput.value.trim();
    if (!userMessage) return;

    displayMessage("Vous", userMessage);
    userMessageInput.value = "";

    fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            section: sectionSelect.value,
            lesson: lessonSelect.value,
            difficulty: difficultySelect.value,
            questions: currentQuestions,
            history: chatHistory,
            message: userMessage
        })
    })
    .then(res => res.json())
    .then(data => {

        if (data.error) {
            alert(data.error);
            return;
        }

        displayMessage("AI Tutor", data.reply);

        chatHistory.push(
            { role: "user", content: userMessage },
            { role: "assistant", content: data.reply }
        );

        if (window.MathJax) MathJax.typesetPromise();
    });
});

function displayMessage(sender, message) {

    const messageDiv = document.createElement("div");
    messageDiv.innerHTML = `
        <p><strong>${sender}:</strong></p>
        <div>${message}</div>
        <hr>
    `;

    chatHistoryContainer.appendChild(messageDiv);
    chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
}


// =========================
// RESET CHAT
// =========================
resetChatButton.addEventListener("click", function () {
    chatHistory = [];
    chatHistoryContainer.innerHTML = "";
});
document.getElementById("lessonBtn").addEventListener("click", function () {

    const section = sectionSelect.value;
    const lesson = lessonSelect.value;

    if (!section || !lesson) {
        alert("Veuillez s√©lectionner une section et une le√ßon.");
        return;
    }

    const lessonContainer = document.getElementById("lesson-container");

    lessonContainer.innerHTML = "‚è≥ G√©n√©ration du cours...";
    lessonContainer.classList.add("show");

    fetch("/lesson_content", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ section, lesson })
    })
    .then(res => res.json())
    .then(data => {

        if (data.error) {
            lessonContainer.innerHTML = "Erreur lors de la g√©n√©ration.";
            return;
        }

      lessonContainer.innerHTML = `
    <div class="lesson-content">
        ${marked.parse(data.lesson)}
    </div>
`;


        if (window.MathJax) MathJax.typesetPromise();
    });
});


</script>

</body>
</html>
