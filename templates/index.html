<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>BacBoost</title>

    <!-- MathJax Config -->
    <script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$']],
            displayMath: [['$$', '$$']]
        },
        svg: { fontCache: 'global' }
    };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

    <style>
        #chat-container {
    position: fixed;
    top: 10%;
    right: 0;
    width: 300px;
    height: 80%;
    background-color: white;
    box-shadow: -2px 2px 10px rgba(0, 0, 0, 0.1);
    padding: 15px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

#chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#chat-history {
    overflow-y: auto;
    flex-grow: 1;
    margin-bottom: 10px;
}

#user-message {
    width: 100%;
    height: 50px;
    margin-top: 10px;
}

#send-message, #reset-chat {
    padding: 10px;
    cursor: pointer;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    margin-top: 5px;
}

#send-message:hover, #reset-chat:hover {
    background-color: #45a049;
}

        body {
            font-family: Arial;
            margin: 40px;
            background-color: #f5f5f5;
        }

        .question-box {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }

        select, button {
            padding: 8px;
            margin-right: 10px;
        }

        button {
            cursor: pointer;
        }

        h1 {
            margin-bottom: 20px;
        }

        hr {
            margin: 30px 0;
        }
    </style>
</head>
<body>

<h1>üöÄ BacBoost - G√©n√©rateur d'exercices Bac</h1>

<select id="section">
    <option value="">Choisir une section</option>
    <option value="Mathematics">Math√©matiques</option>
    <option value="Science">Sciences</option>
    <option value="Economics">√âconomie</option>
    <option value="Technical">Technique</option>
    <option value="Informatique">Informatique</option>
</select>

<select id="lesson">
    <option value="">Choisir une le√ßon</option>
</select>
<select id="difficultySelect">
    <option value="easy">Facile</option>
    <option value="medium" selected>Moyen</option>
    <option value="hard">Difficile</option>
</select>


<button id="generateBtn">G√©n√©rer les exercices</button>

<hr>
<!-- Chat Panel (Right Side) -->
 <div id="exam-container"></div>
<div id="chat-container">
    <div id="chat-header">
        <h3>AI Tutor</h3>
        <button id="reset-chat">Reset Chat</button>
    </div>
    <div id="chat-history">
        <!-- Chat history will appear here -->
    </div>
    <textarea id="user-message" placeholder="Posez votre question..."></textarea>
    <button id="send-message">Envoyer</button>
</div>



<script>
    let chatHistory = []; // Store conversation history
    let currentQuestions = [];


const sendMessageButton = document.getElementById("send-message");
const userMessageInput = document.getElementById("user-message");
const chatHistoryContainer = document.getElementById("chat-history");
const resetChatButton = document.getElementById("reset-chat");


const sectionSelect = document.getElementById("section");
const lessonSelect = document.getElementById("lesson");
const difficultySelect = document.getElementById("difficultySelect");

sectionSelect.addEventListener("change", function () {

    const section = sectionSelect.value;
    lessonSelect.innerHTML = "<option value=''>Choisir une le√ßon</option>";

    if (!section) return;

    fetch(`/lessons/${section}`)
        .then(res => res.json())
        .then(data => {

            if (data.error) {
                alert(data.error);
                return;
            }

            data.lessons.forEach(lesson => {
                const option = document.createElement("option");
                option.value = lesson;
                option.textContent = lesson;
                lessonSelect.appendChild(option);
            });
        });
});


document.getElementById("generateBtn").addEventListener("click", function () {

    const section = sectionSelect.value;
    const lesson = lessonSelect.value;
    const difficulty = difficultySelect.value;
    let chatHistory = [];
let currentQuestions = [];

const sendMessageButton = document.getElementById("send-message");
const userMessageInput = document.getElementById("user-message");
const chatHistoryContainer = document.getElementById("chat-history");
const resetChatButton = document.getElementById("reset-chat");



    if (!section || !lesson) {
        alert("Veuillez s√©lectionner une section et une le√ßon.");
        return;
    }

    fetch("/generate", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            section: section,
            lesson: lesson,
            difficulty: difficulty
        })
    })
    .then(res => res.json())
    .then(data => {

        if (data.error) {
            alert(data.error);
            return;
        }

        const container = document.getElementById("exam-container");
        container.innerHTML = "";
        currentQuestions = data.questions;
chatHistory = [];
chatHistoryContainer.innerHTML = "";


        data.questions.forEach((question, index) => {
            currentQuestions = data.questions;
chatHistory = [];
chatHistoryContainer.innerHTML = "";


            const div = document.createElement("div");
            div.className = "question-box";

            div.innerHTML = `
                <h3>Exercice ${index + 1}</h3>
                <div>${question}</div>
                <br>
                <button onclick="getSolution(${index + 1})">
                    Voir la correction
                </button>
                <div id="solution-${index + 1}"></div>
            `;

            div.dataset.question = question;
            container.appendChild(div);
        });

        if (window.MathJax) {
            MathJax.typesetPromise();
        }
    });
});


function getSolution(questionId) {

    const questionDiv = document.querySelectorAll(".question-box")[questionId - 1];
    const questionText = questionDiv.dataset.question;

    fetch("/solve", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ question_text: questionText })
    })
    .then(res => res.json())
    .then(data => {

        const solutionDiv = document.getElementById("solution-" + questionId);

        if (data.error) {
            solutionDiv.innerHTML = "<p style='color:red;'>Erreur lors de la g√©n√©ration.</p>";
            return;
        }

        solutionDiv.innerHTML = `
            <p><strong>Correction :</strong></p>
            <div>${data.solution}</div>
        `;

        if (window.MathJax) {
            MathJax.typesetPromise();
        }
    });
}
// =========================
// CHAT SEND MESSAGE
// =========================

sendMessageButton.addEventListener("click", function () {

    const userMessage = userMessageInput.value.trim();
    if (!userMessage) return;

    displayMessage("Vous", userMessage);

    userMessageInput.value = "";

    fetch("/chat", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            section: sectionSelect.value,
            lesson: lessonSelect.value,
            difficulty: difficultySelect.value,
            questions: currentQuestions,
            history: chatHistory,
            message: userMessage
        })
    })
    .then(res => res.json())
    .then(data => {

        if (data.error) {
            alert(data.error);
            return;
        }

        displayMessage("AI Tutor", data.reply);

        chatHistory.push(
            { role: "user", content: userMessage },
            { role: "assistant", content: data.reply }
        );

        if (window.MathJax) {
            MathJax.typesetPromise();
        }
    });
});

function displayMessage(sender, message) {

    const messageDiv = document.createElement("div");
    messageDiv.innerHTML = `
        <p><strong>${sender}:</strong></p>
        <div>${message}</div>
        <hr>
    `;

    chatHistoryContainer.appendChild(messageDiv);
    chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
}

// =========================
// RESET CHAT
// =========================

resetChatButton.addEventListener("click", function () {
    chatHistory = [];
    chatHistoryContainer.innerHTML = "";
});

</script>


</body>
</html>
